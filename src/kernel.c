#include "../include/kernel.h"


/*
typedef struct {
    UINT32                                 MaxMode;
    UINT32                                 Mode;
    EFI_GRAPHICS_OUTPUT_MODE_INFORMATION   *Info;
    UINTN                                  SizeOfInfo;
    EFI_PHYSICAL_ADDRESS                   FrameBufferBase;
    UINTN                                  FrameBufferSize;
} EFI_GRAPHICS_OUTPUT_PROTOCOL_MODE;
 
typedef struct {
    UINT32                     Version;
    UINT32                     HorizontalResolution;
    UINT32                     VerticalResolution;
    EFI_GRAPHICS_PIXEL_FORMAT  PixelFormat;
    EFI_PIXEL_BITMASK          PixelInformation;
    UINT32                     PixelsPerScanLine;
} EFI_GRAPHICS_OUTPUT_MODE_INFORMATION;

typedef struct{
    CHAR16*                            FirmwareVendor;
    uint32_t                           FirmwareRevision;
    EFI_RUNTIME_SERVICES*              RuntimeServices;
    EFI_MEMORY_DESCRIPTOR*             MemoryMap;
    uint64_t                           MemoryMapSize;
    uint64_t                           MemoryMapDescriptorSize;
    EFI_GRAPHICS_OUTPUT_PROTOCOL_MODE* GOP;
    EFI_PHYSICAL_ADDRESS               fb; //backbuffer
    EFI_PHYSICAL_ADDRESS               kernelStack;
    uint64_t                           kernelStackSize;
} KERNEL_CONTEXT_TABLE;
*/


void kernel_main(KERNEL_CONTEXT_TABLE* ctx){
    
    //set GDT entries
    GDT_Entry GDT[3];
    GDT_Descriptor GDTPtr;

    GDTPtr.size = sizeof(GDT)-1;
    GDTPtr.offset = (uint64_t)&GDT;

    setGDTEntry(&GDT[0], 0, 0, 0, 0); //null descriptor right here

    setGDTEntry(&GDT[1], 0, 0, //Code segment, base and limit 0 because long mode
    0b10011010, //Access:present, ring 0, non system segment(code/data segment), executable(code segment), non conforming, readable, access
    0b1010 //granularity: page granularity(not byte), size flag(0 because long mode), long mode code, reserved
    );

    setGDTEntry(&GDT[2], 0, 0, //Data segment, base and limit 0 because long mode
    0b10010010, //Access:present, ring 0, non system segment(code/data segment), non executable(data segment), up direction, writable, access
    0b1000 //granularity: page granularity(not byte), size flag(0 because long mode data), not long mode code, reserved
    );
    //load the GDT
    asm volatile(
        ".intel_syntax noprefix\n"
        "lgdt [%[gdt]]\n"
        "mov ax, 0x10\n"
        "mov ds, ax\n"
        "mov es, ax\n"
        "mov fs, ax\n"
        "mov gs, ax\n"
        "mov ss, ax\n"
        "jmp .gdt_loaded_yiper\n"
        ".gdt_loaded_yiper:\n"
        ".att_syntax\n"
        :
        : [gdt] "r"(&GDTPtr)
        : "memory", "rax"
    );

    uint8_t CODE_SEG = sizeof(GDT[0]);
    uint8_t DATA_SEG = sizeof(GDT[0]) * 2;


/*
typedef struct __attribute__((packed)) {
    uint16_t offset_low;
    uint16_t segment;
    uint8_t ist;
    uint8_t attributes;
    uint16_t offset_mid;
    uint32_t offset_high;
    uint32_t reserved;
} IDT_Entry;
*/ 

    while(ctx->GOP->Info->PixelFormat != 1);

    //data section
    uint32_t versionMajor = 1;
    uint32_t versionMinor = 0;
    //font
    uint8_t VGAfont[] = {
        //32
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //33
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        //34
        0b00000000,
        0b00000000,
        0b00000000,
        0b00010100,
        0b00010100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //35
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100100,
        0b00100100,
        0b01111110,
        0b00100100,
        0b00100100,
        0b00100100,
        0b00100100,
        0b01111110,
        0b00100100,
        0b00100100,
        0b00000000,
        0b00000000,
        0b00000000,
        //36
        0b00000000,
        0b00010000,
        0b00010000,
        0b01111100,
        0b01010000,
        0b01010000,
        0b01010000,
        0b01111100,
        0b00010100,
        0b00010100,
        0b00010100,
        0b01111100,
        0b00010000,
        0b00010000,
        0b00000000,
        0b00000000,
        //37
        0b00000000,
        0b00000000,
        0b00000000,
        0b01110001,
        0b01010010,
        0b01110010,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00100111,
        0b01000101,
        0b01000111,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //38
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00100100,
        0b00100100,
        0b00011000,
        0b00010001,
        0b00101010,
        0b01001010,
        0b01000100,
        0b01001100,
        0b00110010,
        0b00000010,
        0b00000000,
        //39
        0b00000000,
        0b00000000,
        0b00000000,
        0b00010000,
        0b00010000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //40
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001000,
        0b00010000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00010000,
        0b00001000,
        0b00000000,
        0b00000000,
        0b00000000,
        //41
        0b00000000,
        0b00000000,
        0b00000000,
        0b00010000,
        0b00001000,
        0b00000100,
        0b00000100,
        0b00000100,
        0b00000100,
        0b00000100,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00000000,
        0b00000000,
        0b00000000,
        //42
        0b00000000,
        0b00100100,
        0b00011000,
        0b01111110,
        0b00011000,
        0b00100100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //43
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b01111100,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //44
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00110000,
        0b00000000,
        0b00000000,
        0b00000000,
        //45
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //46
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        //47
        0b00000000,
        0b00000000,
        0b00000100,
        0b00000100,
        0b00001000,
        0b00001000,
        0b00010000,
        0b00010000,
        0b00100000,
        0b00100000,
        0b01000000,
        0b01000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //48
        0b00000000,
        0b00000000,
        0b00011000,
        0b00100100,
        0b01000010,
        0b01000010,
        0b01000110,
        0b01001010,
        0b01010010,
        0b01100010,
        0b01000010,
        0b01000010,
        0b00100100,
        0b00011000,
        0b00000000,
        0b00000000,
        //49
        0b00000000,
        0b00001000,
        0b00011000,
        0b00101000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00111110,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //50
        0b00000000,
        0b00000000,
        0b00011000,
        0b00100100,
        0b01000010,
        0b00000010,
        0b00000010,
        0b00001100,
        0b00110000,
        0b01000000,
        0b01000000,
        0b01111110,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //51
        0b00000000,
        0b00000000,
        0b00011000,
        0b00100100,
        0b01000010,
        0b00000010,
        0b00000100,
        0b00011000,
        0b00000100,
        0b00000010,
        0b01000010,
        0b00100100,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        //52
        0b00000000,
        0b00000000,
        0b00100010,
        0b00100010,
        0b00100010,
        0b00100010,
        0b00111110,
        0b00000010,
        0b00000010,
        0b00000010,
        0b00000010,
        0b00000010,
        0b00000010,
        0b00000000,
        0b00000000,
        0b00000000,
        //53
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b01000000,
        0b01000000,
        0b01111000,
        0b00000100,
        0b00000010,
        0b00000010,
        0b01000010,
        0b00111100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //54
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011100,
        0b00100000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
        0b00000000,
        0b00000000,
        //55
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b00000010,
        0b00000100,
        0b00000100,
        0b00001000,
        0b00001000,
        0b00010000,
        0b00010000,
        0b00100000,
        0b00100000,
        0b00000000,
        0b00000000,
        0b00000000,
        //56
        0b00000000,
        0b00000000,
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
        0b00000000,
        0b00000000,
        //57
        0b00000000,
        0b00000000,
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000010,
        0b00000010,
        0b00000100,
        0b00001000,
        0b00110000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //58
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //59
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00001000,
        0b00110000,
        0b00000000,
        0b00000000,
        0b00000000,
        //60
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00100000,
        0b01000000,
        0b00100000,
        0b00010000,
        0b00001000,
        0b00000100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //61
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //62
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100000,
        0b00010000,
        0b00001000,
        0b00000100,
        0b00000010,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00100000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //63
        0b00000000,
        0b00000000,
        0b00011000,
        0b00100100,
        0b01000010,
        0b01000010,
        0b00000100,
        0b00001000,
        0b00001000,
        0b00011000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        //64
        0b00000000,
        0b00000000,
        0b00111000,
        0b01000100,
        0b10000010,
        0b10000010,
        0b10010010,
        0b10101010,
        0b10011010,
        0b10000100,
        0b01000001,
        0b00100010,
        0b00011100,
        0b00000000,
        0b00000000,
        0b00000000,
        //65
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00100100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00000000,
        0b00000000,
        0b00000000,
        //66
        0b00000000,
        0b00000000,
        0b01111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111100,
        0b00000000,
        0b00000000,
        0b00000000,
        //67
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011110,
        0b00100000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00100000,
        0b00011110,
        0b00000000,
        0b00000000,
        0b00000000,
        //68
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111000,
        0b01000100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000100,
        0b01111000,
        0b00000000,
        0b00000000,
        0b00000000,
        //69
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01111110,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01111110,
        0b00000000,
        0b00000000,
        0b00000000,
        //70
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01111110,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //71
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111100,
        0b01000010,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01001110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
        0b00000000,
        0b00000000,
        //72
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00000000,
        0b00000000,
        0b00000000,
        //73
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00111000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //74
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001110,
        0b00000100,
        0b00000100,
        0b00000100,
        0b00000100,
        0b01000100,
        0b01000100,
        0b01000100,
        0b00111000,
        0b00000000,
        0b00000000,
        0b00000000,
        //75
        0b00000000,
        0b00000000,
        0b01000010,
        0b01000010,
        0b01000100,
        0b01001000,
        0b01010000,
        0b01100000,
        0b01010000,
        0b01001000,
        0b01000100,
        0b01000010,
        0b01000010,
        0b00000000,
        0b00000000,
        0b00000000,
        //76
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01111110,
        0b00000000,
        0b00000000,
        0b00000000,
        //77
        0b00000000,
        0b00000000,
        0b00000000,
        0b11000110,
        0b10101010,
        0b10101010,
        0b10010010,
        0b10010010,
        0b10010010,
        0b10000010,
        0b10000010,
        0b10000010,
        0b10000010,
        0b00000000,
        0b00000000,
        0b00000000,
        //78
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000010,
        0b01100010,
        0b01100010,
        0b01010010,
        0b01010010,
        0b01001010,
        0b01001010,
        0b01000110,
        0b01000110,
        0b01000010,
        0b00000000,
        0b00000000,
        0b00000000,
        //79
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
        0b00000000,
        0b00000000,
        //80
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //81
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01001010,
        0b01000110,
        0b00111110,
        0b00000011,
        0b00000001,
        0b00000000,
        //82
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01100000,
        0b01010000,
        0b01001000,
        0b01000100,
        0b01000010,
        0b00000000,
        0b00000000,
        0b00000000,
        //83
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111110,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00111100,
        0b00000010,
        0b00000010,
        0b00000010,
        0b01111100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //84
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b01111110,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        //85
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111100,
        0b00000000,
        0b00000000,
        0b00000000,
        //86
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00100100,
        0b00100100,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //87
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b10000001,
        0b10000001,
        0b10000001,
        0b10011001,
        0b10011001,
        0b10100101,
        0b11000011,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //88
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00100100,
        0b00011000,
        0b00011000,
        0b00100100,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00000000,
        0b00000000,
        0b00000000,
        //89
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00100100,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        //90
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b00000010,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00100000,
        0b01000000,
        0b01111110,
        0b00000000,
        0b00000000,
        0b00000000,
        
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,

        0b00000000,
        0b00000000,
        0b01000000,
        0b01000000,
        0b00100000,
        0b00100000,
        0b00010000,
        0b00010000,
        0b00001000,
        0b00001000,
        0b00000100,
        0b00000100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,

        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,

        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001000,
        0b00010100,
        0b00100010,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,

        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01111110,
        0b00000000,
        0b00000000,

        0b00000000,
        0b01000000,
        0b00100000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //97
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111000,
        0b00000100,
        0b00111100,
        0b01000100,
        0b01000100,
        0b00111100,
        0b00000010,
        0b00000000,
        //98
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01000000,
        0b01111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b00000000,
        0b00000000,
        //99
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111110,
        0b01000000,
        0b01000000,
        0b01000000,
        0b00111110,
        0b00000000,
        0b00000000,
        //100
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000010,
        0b00000010,
        0b00000010,
        0b00000010,
        0b00111110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b00111110,
        0b00000000,
        0b00000000,
        //101
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111100,
        0b01000010,
        0b01000010,
        0b01111100,
        0b01000000,
        0b00111100,
        0b00000000,
        0b00000000,
        //102
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001000,
        0b00010100,
        0b00010000,
        0b00010000,
        0b00111000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00100000,
        0b00000000,
        0b00000000,
        //103
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001100,
        0b00010010,
        0b00010010,
        0b00001110,
        0b00000010,
        0b00000010,
        0b00000010,
        0b00100010,
        0b00011100,
        0b00000000,
        0b00000000,
        0b00000000,
        //104
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00111000,
        0b00100100,
        0b00100100,
        0b00100100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //105
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001000,
        0b00000000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //106
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001000,
        0b00000000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b01001000,
        0b00110000,
        0b00000000,
        0b00000000,
        //107
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100000,
        0b00100000,
        0b00100100,
        0b00101000,
        0b00110000,
        0b00101000,
        0b00100100,
        0b00000000,
        0b00000000,
        0b00000000,
        //108
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00001000,
        0b00000000,
        0b00000000,
        0b00000000,
        //109
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000100,
        0b01101100,
        0b01010100,
        0b01000100,
        0b01000100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //110
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b01000100,
        0b01100100,
        0b01010100,
        0b01001100,
        0b01000100,
        0b01000100,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //111
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00100100,
        0b00100100,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        //112
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111000,
        0b00100100,
        0b00100100,
        0b00111000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00100000,
        0b00000000,
        0b00000000,
        //113
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011100,
        0b00100100,
        0b00100100,
        0b00011100,
        0b00000100,
        0b00000100,
        0b00000110,
        0b00000100,
        0b00000000,
        0b00000000,
        //114
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00101100,
        0b00110000,
        0b00100000,
        0b00100000,
        0b00000000,
        0b00000000,
        0b00000000,
        //115
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00100000,
        0b00100000,
        0b00011000,
        0b00000100,
        0b00000100,
        0b00011000,
        0b00000000,
        0b00000000,
        //116
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001000,
        0b00011100,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001100,
        0b00000000,
        0b00000000,
        //117
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100100,
        0b00100100,
        0b00100100,
        0b00011100,
        0b00000010,
        0b00000000,
        0b00000000,
        //118
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100010,
        0b00100010,
        0b00010100,
        0b00001000,
        0b00000000,
        0b00000000,
        0b00000000,
        //119
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100010,
        0b00101010,
        0b00010100,
        0b00000000,
        0b00000000,
        0b00000000,
        //120
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100010,
        0b00010100,
        0b00001000,
        0b00010100,
        0b00100010,
        0b00000000,
        0b00000000,
        //121
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100010,
        0b00010100,
        0b00001000,
        0b00010000,
        0b00100000,
        0b01000000,
        0b00000000,
        0b00000000,
        //122
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00111100,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00100000,
        0b00111100,
        0b00000000,
        0b00000000,
        //123
        0b00000000,
        0b00000000,
        0b00000000,
        0b00001000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00100000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00001000,
        0b00000000,
        0b00000000,
        //124
        0b00000000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00000000,
        //125
        0b00000000,
        0b00000000,
        0b00000000,
        0b00100000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00001000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00010000,
        0b00100000,
        0b00000000,
        0b00000000,
        //126
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00110000,
        0b01001001,
        0b00000110,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000
    };



    //Display
    //swap the buffers so the GOP framebuffer is actually the backbuffer
    {
        EFI_PHYSICAL_ADDRESS backbuf = ctx->fb;
        ctx->fb = ctx->GOP->FrameBufferBase; //set fb to vram
        ctx->GOP->FrameBufferBase = backbuf; //set the GOP address to backbuffer
    }

    GOPDrawRect(ctx->GOP, 0, 0, ctx->GOP->Info->HorizontalResolution-1, ctx->GOP->Info->VerticalResolution-1, rgba(0, 0, 0, 0), true);

    bool fill = true;
    uint32_t screenX = ctx->GOP->Info->HorizontalResolution - 1;
    uint32_t screenYFraction = ctx->GOP->Info->VerticalResolution / 5;
    for(int i=0;i<200;i++){
    GOPDrawRect(ctx->GOP, 0, 0, screenX, screenYFraction - 1, hex(0x55CDFC), fill);
    GOPDrawRect(ctx->GOP, 0, screenYFraction, screenX, 2*screenYFraction - 1, hex(0xF7A8B8), fill);
    GOPDrawRect(ctx->GOP, 0, 2*screenYFraction, screenX, 3*screenYFraction - 1, hex(0xFFFFFF), fill);
    GOPDrawRect(ctx->GOP, 0, 3*screenYFraction, screenX, 4*screenYFraction - 1, hex(0xF7A8B8), fill);
    GOPDrawRect(ctx->GOP, 0, 4*screenYFraction, screenX, 5*screenYFraction - 1, hex(0x55CDFC), fill);
    }

    KERNEL_TEXT_OUTPUT title = {VGAfont, 8, 16, 4, 4, 0, 0, 20, 20, hex(0xFF10F0), hex(0x000000), true};
    KERNEL_TEXT_OUTPUT ConOut = {VGAfont, 8, 16, 2, 2, 0, 6, 0, 0, hex(0xFF10F0), hex(0x000000), false};

    printf(ctx->GOP, &title, "Welcome to \r\n");
    title.frontColor = 0xE50000;title.backColor = 0x000000;
    printf(ctx->GOP, &title, "N");
    title.frontColor = 0xFF8D00;title.backColor = 0x000000;
    printf(ctx->GOP, &title, "u");
    title.frontColor = 0xFFEE00;title.backColor = 0x000000;
    printf(ctx->GOP, &title, "c");
    title.frontColor = 0x028121;title.backColor = 0x000000;
    printf(ctx->GOP, &title, "k");
    title.frontColor = 0xFF10F0;title.backColor = 0x000000;
    printf(ctx->GOP, &title, " ");
    title.frontColor = 0x004CFF;title.backColor = 0x000000;
    printf(ctx->GOP, &title, "O");
    title.frontColor = 0x770088;title.backColor = 0x000000;
    printf(ctx->GOP, &title, "S");
    title.frontColor = 0xFF10F0;title.backColor = 0x000000;

    printf(ctx->GOP, &title, " Version %u.%u!\r\n", versionMajor, versionMinor);

    printf(ctx->GOP, &ConOut, "From the %s to the %s to the %s to the %s\r\nWhere's my crown, that's my bling, always %f when I ring\r\n", "screen", "ring", "pen", "king", 1.7);
    printf(ctx->GOP, &ConOut, "It's pride month!\r\n");

    printf(ctx->GOP, &ConOut, "Code segment: %x\r\nData segment: %x\r\n", CODE_SEG, DATA_SEG);

    
    memcpy((void*)ctx->GOP->FrameBufferBase, (void*)ctx->fb, ctx->GOP->FrameBufferSize);
    while(true);
}

void setIDTEntry(IDT_Entry* entry, uint64_t offset, uint16_t segment, uint8_t ISTOffset, uint8_t attributes){
    entry->offset_low = (uint16_t)(offset & 0xFFFF);
    entry->segment = segment;
    entry->ist = (uint8_t)(ISTOffset & 0b111); //only last 3 bits are the ist, 5 high bits set to 0 because reserved
    entry->attributes = attributes;
    entry->offset_mid = (uint16_t)((offset >> 16) & 0xFFFF);
    entry->offset_high = (uint32_t)((offset >> 32) & 0xFFFFFFFF);
    entry->reserved = 0;
}

void setGDTEntry(GDT_Entry* entry, uint32_t base, uint32_t limit, uint8_t access, uint8_t flags){
    entry->limit_low = (uint16_t)(limit & 0xFFFF);
    entry->base_low = (uint16_t)(base & 0xFFFF);
    entry->base_mid = (uint8_t)((base >> 16) & 0xFF);
    entry->access = access;
    entry->limit__flags = (uint8_t)(((limit >> 16) & 0xF) | (flags << 4));
    entry->base_high = (uint8_t)(base >> 24);
}

void triple_fault(){
    uint64_t egg = 0;
    asm volatile (
        ".intel_syntax noprefix\n"
        "lidt [%[eggman]]\n"
        ".byte 0x0F, 0x0B\n" //invalid opcode(fault), invalid idt(double fault), exception handler not found(triple fault)
        ".att_syntax\n"
        :
        : [eggman] "r"(&egg)
    );
}

void* memcpy(void* source, void* dest, uint64_t size){
    uint8_t* d = (uint8_t*) dest;
    uint8_t* s = (uint8_t*) source;
    while(size > sizeof(uint64_t)){ //64 bit copy
        *(uint64_t*)d = *(uint64_t*)s;
        s += sizeof(uint64_t);
        d += sizeof(uint64_t);
        size -= sizeof(uint64_t);
    }
    while(size--){
        *d++ = *s++;
    }
    return dest;
}

void printf(EFI_GOP* GOP, KERNEL_TEXT_OUTPUT* ConOut, uint8_t* str, ...){
    va_list args;
    va_start(args, str);

    bool longType = false;
    while (*str) {
        if(*str != '%'){ //if not a format specifier
            printChar(GOP, ConOut, *str++);
            continue;
        }
        str++; //skip the '%'

        if(*str == 0){
            break;
        }
        if(*str == '%'){
            printChar(GOP, ConOut, '%');
            str++;
            continue;
        }

        longType = false;
        if(*str == 'l'){
            longType = true;
            str++;
            if(*str == 0){
                break;
            }
        }

        char format = *str; //character
        switch(format){
            case 'c': //char
                printChar(GOP, ConOut, (uint8_t)va_arg(args, int32_t));
                break;
            case 's': //string
                printString(GOP, ConOut, (uint8_t*)va_arg(args, uint8_t*));
                break;

            case 'd':
            case 'i': //signed int
                if(longType){
                    printInt(GOP, ConOut, (int64_t)va_arg(args, int64_t), 10);
                }
                else{
                    printInt(GOP, ConOut, (int64_t)va_arg(args, int32_t), 10); 
                }
                break;
            
            case 'u': //unsigned int
                if(longType){
                    printUint(GOP, ConOut, (uint64_t) va_arg(args, uint64_t), 10);
                }
                else{
                    printUint(GOP, ConOut, (uint64_t) va_arg(args, uint32_t), 10);
                }
                break;

            case 'o': //octal
                if(longType){
                    printUint(GOP, ConOut, (uint64_t) va_arg(args, uint64_t), 8);
                }
                else{
                    printUint(GOP, ConOut, (uint64_t) va_arg(args, uint32_t), 8);
                }
                break;
            case 'x': //hex
            case 'X': //hex
                if(longType){
                    printUint(GOP, ConOut, (uint64_t) va_arg(args, uint64_t), 16);
                }
                else{
                    printUint(GOP, ConOut, (uint64_t) va_arg(args, uint32_t), 16);
                }
                break;

            case 'p': //pointer
                printUint(GOP, ConOut, (uint64_t)va_arg(args, void*), 16);
                break;
            
            case 'f': //float
                if(longType){
                    printFloat(GOP, ConOut, (double) va_arg(args, double), 16); 
                }
                else{
                    printFloat(GOP, ConOut, (double) va_arg(args, double), 6);
                }
                break;
            case 'l':
                printChar(GOP, ConOut, 'l');
                break;
            case 'n': //nothing
                break;
            default:
                //nuh uh, print the character itself
                printChar(GOP, ConOut, '%');
                printChar(GOP, ConOut, format);
                str--;
                break;
        }
        str++;
    }
    va_end(args);
}
void printFloat(EFI_GOP* GOP, KERNEL_TEXT_OUTPUT* ConOut, double num, uint8_t prec){
    if(num < 0.0){
        printChar(GOP, ConOut, '-');
        num = -num;
    }
    printUfloat(GOP, ConOut, num, prec);
}
void printUfloat(EFI_GOP* GOP, KERNEL_TEXT_OUTPUT* ConOut, double num, uint8_t prec){
    printUint(GOP, ConOut, (uint64_t)num, 10); //print integer part
    printChar(GOP, ConOut, '.');
    num -= (double)(uint64_t)num;
    uint8_t digit;
    for(uint8_t c = 0;c < prec;c++){
        num *= 10.0;
        digit = (uint8_t)num;
        printChar(GOP, ConOut, digit + '0');
        num -= digit;
    }
}
void printInt(EFI_GOP* GOP, KERNEL_TEXT_OUTPUT* ConOut, int64_t num, uint8_t base){
    if(num < 0){
        printChar(GOP, ConOut, '-');
        printUint(GOP, ConOut, (uint64_t)(-num), base);
        return;
    }
    printUint(GOP, ConOut, num, base);
}
void printUint(EFI_GOP* GOP, KERNEL_TEXT_OUTPUT* ConOut, uint64_t num, uint8_t base){
    if(base < 2 || base > 16)return;

    if(base == 2)printString(GOP, ConOut, "0b");
    else if(base == 8)printString(GOP, ConOut, "0o");
    else if(base == 16)printString(GOP, ConOut, "0x");

    if(num == 0){
        printChar(GOP, ConOut, '0');
        return;
    }

    uint8_t buff[65]; //buffer to store digits
    buff[64] = 0;
    uint8_t index = 64;

    uint8_t* charmap = "0123456789ABCDEF"; //character map

    while(num != 0){
        index--;
        buff[index] = charmap[num % base]; //push digit to buffer
        num /= base;
    }
    printString(GOP, ConOut, &buff[index]);
}
void printString(EFI_GOP* GOP, KERNEL_TEXT_OUTPUT* ConOut, uint8_t* string){
    while(*string){ //while it's not null
        printChar(GOP, ConOut, *string++);
    }
}
void printChar(EFI_GOP* GOP, KERNEL_TEXT_OUTPUT* ConOut, uint8_t ascii_char){
    uint32_t maxWidth = GOP->Info->HorizontalResolution / (ConOut->charWidth*ConOut->scaleX);
    uint32_t maxHeight = GOP->Info->VerticalResolution / (ConOut->charHeight*ConOut->scaleY);
    if(ascii_char == 0){ //null character
        return;
    }
    if(ascii_char == '\r'){
        ConOut->cursorX = 0;
        return;
    }
    if(ascii_char == '\n'){
        ConOut->cursorY++;
        if(ConOut->cursorY >= maxHeight){
            ConOut->cursorY = 0; //TODO: replace this line with scroll
        }
        return;
    }
    if(ascii_char < 32 || ascii_char > 126){ //non printable
        ascii_char = ' '; //space
    }

    //print ascii character at cursorX, cursorY
    uint32_t screenX = ConOut->cursorX * ConOut->charWidth * ConOut->scaleX; //screen position to print character to
    uint32_t screenY = ConOut->cursorY * ConOut->charHeight * ConOut->scaleY;

    screenX += (ConOut->useAbsolutePosition) ? ConOut->offsetX : 0;
    screenY += (ConOut->useAbsolutePosition) ? ConOut->offsetY : 0;

    uint32_t startingIndex = (ascii_char-32)*ConOut->charHeight; //starting index of the font array for the character
    for(uint32_t dy = 0;dy < ConOut->charHeight;dy++){
        uint8_t row = ConOut->font[startingIndex + dy];
        for(uint32_t dx = 0;dx < ConOut->charWidth;dx++){
            uint32_t color = (row & (1 << (7 - dx))) ? ConOut->frontColor : ConOut->backColor;
            for(uint32_t scaleYOff = 0;scaleYOff < ConOut->scaleY;scaleYOff++){
                for(uint32_t scaleXOff = 0;scaleXOff < ConOut->scaleX;scaleXOff++){
                    GOPPutPixel(GOP, screenX+(dx*ConOut->scaleX)+scaleXOff, screenY+(dy*ConOut->scaleY)+scaleYOff, color);
                }
            }
        } 
    }
    //advance cursor position
    ConOut->cursorX++;
    if(ConOut->cursorX >= maxWidth){
        ConOut->cursorX = 0;
        ConOut->cursorY++;
    }
    if(ConOut->cursorY >= maxHeight){
        ConOut->cursorY = 0; //TODO: replace this line with scroll
    }
}
void GOPDrawRect(EFI_GOP* GOP, uint32_t x1, uint32_t y1, uint32_t x2, uint32_t y2, uint32_t color, uint8_t fill){
    //convert x, y to memory address
    uint32_t xmax = ((x1 > x2) ? x1 : x2);
    uint32_t xmin = ((x1 > x2) ? x2 : x1);
    uint32_t ymax = ((y1 > y2) ? y1 : y2);
    uint32_t ymin = ((y1 > y2) ? y2 : y1);

    if(!fill){
        for(uint32_t x = xmin;x <= xmax;x++){
            GOPPutPixel(GOP, x, ymin, color);
            GOPPutPixel(GOP, x, ymax, color);
        }
        for(uint32_t y = ymin+1;y < ymax;y++){
            GOPPutPixel(GOP, xmin, y, color);
            GOPPutPixel(GOP, xmax, y, color);
        }
    }
    else{
        for(uint32_t y = ymin;y <= ymax;y++){
            for(uint32_t x = xmin;x <= xmax;x++){
                GOPPutPixel(GOP, x, y, color);
            }
        }
    }
}
void GOPPutPixel(EFI_GOP* GOP, uint32_t x, uint32_t y, uint32_t color){
    //check if x and y are legal
    uint32_t xMax = GOP->Info->HorizontalResolution;
    uint32_t yMax = GOP->Info->VerticalResolution;
    if(x >= xMax || y >= yMax){
        return;
    }
    uint8_t* fb = (uint8_t*) GOP->FrameBufferBase;
    uint32_t ppl = (uint32_t) GOP->Info->PixelsPerScanLine;
    uint8_t* fb_addr = (uint8_t*)(fb + 4 * y * ppl + 4 * x);
    *((uint32_t*)fb_addr) = color;

}
static inline uint32_t rgba(uint8_t r, uint8_t g, uint8_t b, uint8_t a){
    return ((uint32_t)b) | ((uint32_t)g << 8) | ((uint32_t)r << 16) | ((uint32_t)a << 24);
}
static inline uint32_t hex(uint32_t hex){
    return hex | 0xFF000000;
}

